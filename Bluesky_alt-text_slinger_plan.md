# Bluesky Alt-Text Slinger â€“ Plan

## 1. High-level architecture

Linux-based web app that:

1. Authenticates to Bluesky using handle + app password.
2. Enumerates all posts with `app.bsky.embed.images` embeds.
3. Displays:
   - Image thumbnails
   - Existing alt text (if any)
   - Suggested alt text (generated by a vision model)
4. Lets the user:
   - Edit alt text for each image
   - Choose which images to update
   - Apply changes back to Bluesky by editing `app.bsky.embed.images.Image.alt`.

Core components:

- Backend: Python + FastAPI
- Bluesky client: `atproto` Python SDK
- Alt-text generator: OpenAI Vision (e.g. `gpt-4o-mini`), pluggable
- Frontend: React (Vite + TS) SPA with a textured, non-purple theme
- Storage: SQLite (via `sqlite3`) for:
  - Users
  - Posts
  - Images (existing + generated alt text, applied status)
- Containerization: Docker image running the backend; frontend runs via Vite dev or separate static hosting.

---

## 2. Bluesky / ATProto flow

- Login with `Client.login(handle, app_password)` using an app password.
- Scan posts with `get_author_feed` and filter to `app.bsky.embed.images#view` embeds.
- For each image:
  - Collect thumb & fullsize URLs and existing `alt`.
- For updates:
  - Parse `at://did/.../app.bsky.feed.post/rkey` URIs.
  - Get the record via `com.atproto.repo.getRecord`.
  - Ensure `record.embed.$type == "app.bsky.embed.images"`.
  - Set `record.embed.images[i].alt = new_alt`.
  - Write back with `com.atproto.repo.putRecord`.

---

## 3. Database schema (SQLite)

Tables:

- `users`
  - `handle` (TEXT PRIMARY KEY)
  - `created_at` (TEXT, default now)

- `posts`
  - `id` (INTEGER PK AUTOINCREMENT)
  - `handle` (TEXT NOT NULL)
  - `uri` (TEXT NOT NULL)
  - `cid` (TEXT)
  - `text` (TEXT)
  - `created_at` (TEXT)
  - `has_images` (INTEGER, 0/1)
  - UNIQUE (`handle`, `uri`)

- `images`
  - `id` (INTEGER PK AUTOINCREMENT)
  - `handle` (TEXT NOT NULL)
  - `post_uri` (TEXT NOT NULL)
  - `image_index` (INTEGER NOT NULL)
  - `thumb_url` (TEXT)
  - `fullsize_url` (TEXT)
  - `current_alt` (TEXT)
  - `generated_alt` (TEXT)
  - `last_applied_alt` (TEXT)
  - `last_status` (TEXT)
  - `updated_at` (TEXT, default now)
  - UNIQUE (`handle`, `post_uri`, `image_index`)

On scan:

- Insert/update `posts` and `images` with latest info.
- Optionally overwrite `generated_alt` with new suggestions.

On apply:

- Update `images.current_alt`, `last_applied_alt`, `last_status`.

---

## 4. Backend endpoints

### `POST /api/scan`

Request:

- `handle`
- `app_password`
- `generate_alt` (bool, default true)

Behavior:

- Login to Bluesky.
- Fetch all posts with images.
- For each image:
  - Include thumb/fullsize URLs, existing `alt`.
  - If `generate_alt` is true and there is no existing alt AND an OpenAI key is present:
    - Generate suggested alt text.
- Save scan results to SQLite.
- Return `ScanResponse` (posts + images + flags).

### `POST /api/apply`

Request:

- `handle`
- `app_password`
- `updates`: list of `{ uri, image_index, new_alt }`.

Behavior:

- Login to Bluesky.
- Group updates by post URI.
- For each post:
  - Fetch record, patch `embed.images[i].alt`.
  - Write back with `putRecord`.
- Update SQLite with application status.
- Return per-URI success/failure list.

---

## 5. Frontend (React)

Key features:

- Login form for handle + app password.
- On scan:
  - Show summary (post count, image count, alt-gen status).
  - Gallery of image cards with:
    - Thumbnail
    - Post text
    - Existing alt text
    - Suggested alt text
    - Editable textarea "alt text to apply"
    - Checkbox "Apply this alt text to Bluesky"
- Filters:
  - Show all
  - Only images missing alt
  - Only images with existing alt
  - Only selected images
- Bulk actions:
  - Select all images with missing alt
  - Clear all selections
- Apply button:
  - Sends selected alt text updates to `/api/apply`.
  - Shows summary banner on success.

Styling:

- Deep slate/blue-gray background with subtle texture.
- Non-purple accents (emerald, teal, blue).
- Glassy cards, rounded corners, soft shadows.

---

## 6. Docker & deployment

- Backend runs in a Python 3.12 slim image:
  - Installs `backend/requirements.txt`.
  - Uses `uvicorn backend.main:app`.
  - SQLite DB path at `/app/data/alttext_slinger.db` (configurable via `ALTTS_DB_PATH`).
- You can mount a host directory as `/app/data` for persistence.
- Frontend runs separately (Vite dev or static build served by your choice of web server).

---